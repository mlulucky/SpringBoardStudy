<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<div layout:fragment="content">
    <h1 class="my-4">
        <span th:text="${crId}"></span>
        Ï±ÑÌåÖÎ∞© ÏÉÅÏÑ∏
    </h1>
    <div class="card">
        <div class="card-header">
            <h2 class="text-center mb-0">Ï±ÑÌåÖ ÎÇ¥Ïó≠</h2>
        </div>

        <div class="card-body overflow-scroll" id="msgCont" style="height:50vh;"></div>

        <div class="card-footer">
            <form action="" name="sendMsgForm">
                <input type="hidden" name="uId" th:value="${session.loginUser.uId}">
                <input type="hidden" name="crId" th:value="${crId}">
                <input type="hidden" name="status" value="CHAT"> <!-- Î©îÏÑ∏ÏßÄ Ï†úÏ∂ú ÏÉÅÌÉú -->
                <input type="hidden" name="nickname" value="">
                <div class="input-group">
                    <textarea name="content" disabled class="form-control"></textarea>
                    <button name="submitBtn" disabled class="btn btn-primary">Ï†úÏ∂ú</button>
                </div>
            </form>
        </div>

        <!-- ÏûÖÏû• Ìèº -->
        <form class="my-4" name="enterMsgForm">
            <input type="hidden" name="uId" th:value="${session.loginUser.uId}">
            <input type="hidden" name="crId" th:value="${crId}">
            <input type="hidden" name="status" value="ENTER">
            <input type="hidden" name="content" value="ÏûÖÏû•">
            <div class="input-group mx-auto" style="width: 400px">
                <div class="form-floating">
                    <input class="form-control" name="nickname" type="text" placeholder="ÎãâÎÑ§ÏûÑ">
                    <label>ÎãâÎÑ§ÏûÑ</label>
                </div>
                <button name="submitBtn" class="btn btn-info text-white">ÏûÖÏû•</button>
            </div>
        </form>



    </div>

    <script th:inline="javascript">
        const LOGIN_USER_ID=[[${session.loginUser.uId}]];
        const msgCont=document.getElementById("msgCont");
        const enterMsgForm=document.forms["enterMsgForm"];
        const sendMsgForm=document.forms["sendMsgForm"]; // ÏΩòÏÜîÏ∞ΩÏóê Î≥ÄÏàòÎ™Ö ÏûÖÎ†•Ìï¥ÏÑú, Ï∞æÏïÑÏßÄÎäîÏßÄ Ï≤¥ÌÅ¨!
        let lastPostTime; // Î©îÏÑ∏ÏßÄÎ•º Î°úÎìúÌïòÎã§Í∞Ä ÎßàÏßÄÎßâ Î©îÏÑ∏ÏßÄÏùò Îì±Î°ùÏãúÍ∞Ñ(Î°úÎî©Îêú ÎßàÏßÄÎßâ Í∏Ä)

        let listUrl=`/chat/msg/[[${crId}]]/list.do`; // if (lastPostTime)? postTime=lastPostTime

        // ÏûêÎ∞îÏä§ÌÅ¨Î¶ΩÌä∏ÏïàÏóêÏÑú ÌÉÄÏûÑÎ¶¨ÌîÑ Î≥ÄÏàòÎ•¥ Ìò∏Ï∂úÌïòÎäî Í≤É -> ÎåÄÍ¥ÑÌò∏ 2Í∞ú
        // ÌôîÎ©¥Ïù¥ Î°úÎìúÎêòÎäî Ïù¥Î≤§Ìä∏ DOMContentLoaded
        document.addEventListener("DOMContentLoaded", async (e)=>{
            // await loadMsgs();
            // setInterval(async ()=>{ // 3Ï¥à Îí§ Î¨¥Ï°∞Í±¥ Ìè¥ÎßÅ
            //     await loadMsgs();
            // },3000); // üçípolling
            await autoLoadMsgs();

        })

        // Ïû¨Í∑ÄÌï®ÏàòÎ°ú Î°úÎìúÎêú ÏãúÏ†êÏóê Ìè¥ÎßÅÌïòÍ∏∞
        async function autoLoadMsgs(){
            let result=await loadMsgs();
            if(result){
                await new Promise((resolve)=>{
                    setTimeout(()=>
                    {resolve},3000)}); // setTimeout Ïù¥ ÎπÑÎèôÍ∏∞ÎùºÏÑú, ÌîÑÎ°úÎØ∏Ïä§ÏïàÏóê ÎÑ£Ïñ¥Ïïº ÌïúÎã§.
                autoLoadMsgs(); // ÎÇ¥Í∞Ä ÎÇ¥ÏûêÏã†ÏùÑ Ìò∏Ï∂ú
            }


        }

        sendMsgForm.onsubmit=async (e)=>{
            e.preventDefault();
            let register=await registerMsg(sendMsgForm);
            if(register>0){
                sendMsgForm.content.value=""; // textarea Í≥µÎ∞±ÏúºÎ°ú ÎßåÎì§Í∏∞
                await loadMsgs();
            }
        }


        enterMsgForm.onsubmit=async(e)=>{
            e.preventDefault();
            let register=await registerMsg(enterMsgForm);
            if(register>0){
                await loadMsgs();
                // alert("Îì±Î°ù ÏÑ±Í≥µ");
                enterMsgForm.nickname.setAttribute("disabled",'');
                enterMsgForm.submitBtn.setAttribute("disabled",'');
                sendMsgForm.nickname.value=enterMsgForm.nickname.value;
                sendMsgForm.content.removeAttribute("disabled");
                sendMsgForm.submitBtn.removeAttribute("disabled");

            }else{
                alert("Îì±Î°ù Ïã§Ìå®");
            }
        }

        async function registerMsg(formNode){ // formNode : Ìèº ÎÖ∏Îìú(ÌÉúÍ∑∏)
            let url="/chat/msg/register.do";
            const data=new FormData(formNode) // ajax Î°ú ÌèºÎç∞Ïù¥ÌÑ∞Î•º Îç∞Ïù¥ÌÑ∞, ÏøºÎ¶¨Ïä§Ìä∏ÎßÅÏúºÎ°ú ÎßåÎìúÎäî Í≤É.
            const resp=await fetch(url,{method:"POST",body:data});
            if(resp.status===200){
                let register=await resp.text(); // 0 Ïã§Ìå®, 1 ÏÑ±Í≥µ
                return register;
            }

        }

        async function loadMsgs(){
            let url=listUrl;
            if(lastPostTime) url+="?postTime="+lastPostTime;
            const response=await fetch(url);
            if(response.status===200){
                // return await response.json();
                const msgs=await response.json();
                msgs.forEach((msg,index)=>{
                    // console.log(msg);
                    // msgCont.insertAdjacentHTML("beforeend", JSON.stringify(msg));
                    if((msgs.length-1)===index) { // ÎßàÏßÄÎßâ Ïù∏Îç±Ïä§
                        lastPostTime=msg.postTime;
                    }

                    if(msg.status==='CHAT'){
                        if(LOGIN_USER_ID===msg.uId){ // Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†ÄÍ∞Ä Î≥¥ÎÇ∏ Î©îÏÑ∏ÏßÄ
                            msgCont.insertAdjacentHTML("beforeend", sendMsgComponent(msg));
                        }else { // Î∞õÏùÄ Î©îÏÑ∏ÏßÄ
                            msgCont.insertAdjacentHTML("beforeend", receiveMsgComponent(msg));
                        }
                    } else if(msg.status==='ENTER') {
                        msgCont.insertAdjacentHTML("beforeend", enterMsgComponent(msg));
                    }else if(msg.status==='LEAVE'){
                        msgCont.insertAdjacentHTML("beforeend", leaveMsgComponent(msg));
                    }
                });
                return true; // üçí Î°úÎìúÍ∞Ä ÏôÑÎ£åÎêú ÏãúÏ†ê => Ìè¥ÎßÅÏóêÏÑú ÏÇ¨Ïö©ÏòàÏ†ï
            }
        }


        function enterMsgComponent(msgObj){  // ÏûÖÏû• Î©îÏÑ∏ÏßÄ
            return `
                <div class="text-center">
                <strong>${msgObj.nickname}</strong>
                <strong>(${msgObj.uId})</strong>
                Îãò ÏûÖÏû•
                <br>
                <small class="text-muted">${msgObj.postTime}</small>
            </div>
            `;
        }
        function leaveMsgComponent(msgObj){ // Ìá¥Ïû• Î©îÏÑ∏ÏßÄ
            return `
                <div class="text-center">
                <strong>${msgObj.nickname}</strong>
                <strong>(${msgObj.uId})</strong>
                Îãò Ìá¥Ïû•
                <br>
                <small class="text-muted">${msgObj.postTime}</small>
            </div>
            `;
        }

        function receiveMsgComponent(msgObj){
            return `
                <div class="d-flex my-2">
                <div class="align-self-start d-flex flex-column"> <!-- ÏÑ∏Î°úÏ†ïÎ†¨ ÏúÑ -->
                    <small>${msgObj.nickname}</small>
                    <strong>${msgObj.uId}</strong>
                </div>
                <div class="bg-primary bg-opacity-10 rounded-2 p-3 mx-2">
                    ${msgObj.content}
                </div>
                <div class="align-self-end"> <!-- ÏÑ∏Î°úÏ†ïÎ†¨ ÏïÑÎûòÎ°ú -->
                    <small class="text-muted">${msgObj.postTime}</small>
                </div>
            </div>
            `;
        }

        function sendMsgComponent(msgObj){
            return `
                <div class="d-flex my-2 justify-content-end">
                    <div class="align-self-end"> <!-- ÏÑ∏Î°úÏ†ïÎ†¨ ÏïÑÎûòÎ°ú -->
                        <small class="text-muted">${msgObj.postTime}</small>
                    </div>
                    <div class="bg-warning bg-opacity-25 rounded-2 p-3 mx-2">
                        ${msgObj.content}
                    </div>
                    <div class="align-self-start d-flex flex-column"> <!-- ÏÑ∏Î°úÏ†ïÎ†¨ ÏúÑ -->
                        <small>${msgObj.nickname}</small>
                        <strong>${msgObj.uId}</strong>
                    </div>
                </div>
            `;
        }





    </script>

</div>
</html>