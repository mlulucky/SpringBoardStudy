<!--í•´ì‹œíƒœê·¸ í™”ë©´ í‘œì‹œ-->
<div id="tagsCont" class="mb-2">
  <!-- íƒœê·¸ë…¸ë“œ -->

</div>

<!--í•´ì‹œíƒœê·¸ ë“±ë¡-->
<div class="input-group">
  <label class="input-group-text bi bi-hash"></label>
  <input id="tagsInput" list="tagsDataList" class="form-control" type="text" placeholder="íƒœê·¸">
</div>

<!-- datalist : ìë™ìœ¼ë¡œ ì„œì¹­ê¸°ëŠ¥ì´ ìˆë‹¤ -->
<datalist id="tagsDataList">

</datalist>

<script>
  const tagsDataList=document.getElementById("tagsDataList");
  const tagsInput=document.getElementById("tagsInput");
  const tagsCont=document.getElementById("tagsCont");
  const tagsSet=new Set(); // Set : ê°™ì€ ê²ƒì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìë£Œ êµ¬ì¡° (ê²€ìƒ‰,ì •ë ¬ì´ ë°°ì—´ë³´ë‹¤ ë¹ ë¥´ë‹¤) // ğŸ’í•´ì‹œíƒœê·¸ê°’ì„ ë‹´ì„ ì˜ˆì •
  //  Set(2) {'í™ëŒ€', 'í™ëŒ€í™ëŒ€ì…êµ¬'}

  // input íƒœê·¸ì˜ press ì´ë²¤íŠ¸ ë§‰ì•„ì£¼ê¸°
  // press ì´ë²¤íŠ¸ : keyup, keydown, keypress(ì‚­ì œ)  ì´ë²¤íŠ¸(e) =>  ì–´ë–¤í‚¤ë¥¼ ëˆŒë €ëŠ”ì§€ ê²€ì‚¬í•œë‹¤
  // ğŸ’**í•œê¸€ì€ ì…ë ¥ë°›ì„ ìˆ˜ ì—†ë‹¤! (í•œê¸€ì€ ììŒëª¨ìŒì´ ì„ì—¬ìˆì–´ì„œ ì•„ì§ ì…ë ¥ì¤‘ì¸ ê°’ì´ë¼ì„œ ì—†ë‹¤ì•š)
  // compositionstart(ì…ë ¥ì¤‘), compositionend(ì…ë ¥ë) : ììŒ ëª¨ìŒì´ ìˆëŠ” ì–¸ì–´(í•œê¸€)ì„ ì…ë ¥í• ë•Œ => ğŸ’ì…ë ¥ë ì§€ì ì—ì„œ space ë¥¼ ë°›ì•„ì•¼ í•œë‹¤
  // í•œê¸€ì…ë ¥ ì¤‘ì— ì—”í„°ë¥¼ ì…ë ¥í•˜ë©´ keydown 2ë²ˆ ë°œìƒí•˜ëŠ” ì´ìœ  : ììŒ ëª¨ìŒì„ í•˜ë‚˜ì˜ ë¬¸ìë¡œ ì™„ì„±í•˜ë˜ ì¤‘(compositionstart) ì—”í„°ë¥¼ ì…ë ¥í•˜ë©´ ë¬¸ìì…ë ¥+ì—”í„° ê°€ ë™ì‹œì— keydown ì„ ë°œìƒì‹œí‚¨ë‹¤.(compositionend ê°€ ë°œìƒí•˜ë©´ keydown ì´ ë°œìƒí•˜ë©´ ì•ˆëœë‹¤)

  let composition=false; // í•œê¸€ì…ë ¥ì¤‘
  tagsInput.addEventListener("compositionstart", (e)=>{ // compositionstart í•œê¸€ì…ë ¥ì¤‘ (ììŒëª¨ìŒì„ ì¡°í•©í•˜ëŠ” ì¤‘ì´ì´ë¼ì„œ)
    composition=true; // í•˜ (ììŒëª¨ìŒ ì™„ì„±ì¼ë•Œ) => ì—”í„°, ìŠ¤í˜ì´ìŠ¤ ì´ë²¤íŠ¸ ë¬´ì‹œí•˜ê¸°
  })

  tagsInput.addEventListener("compositionend", (e)=>{
    composition=false; // í•œê¸€ì…ë ¥ ëë‚¬ì„ë•Œ
    let tagName=tagsInput.value;
    let lastVal=tagName[tagName.length-1]; // "" === ìŠ¤í˜ì´ìŠ¤ (ë§ˆì§€ë§‰ê°’ì´ ìŠ¤í˜ì´ìŠ¤ì¸ì§€ ë¬¼ì–´ë³´ê¸°) // ì…ë ¥í•œ ê°’ì˜ ë¬¸ìì—´ê¸¸ì´ -1 (ë§ˆì§€ë§‰ë¬¸ì)
    console.log("í•œê¸€ì…ë ¥ì™„ë£Œ",tagName,"ë§ˆì§€ë§‰:",lastVal);
    if(lastVal===" "){ // ì…ë ¥ëë‚¬ì„ë•Œ, ì…ë ¥ì»¤ì„œê°€ ìˆì„ë•Œ ìŠ¤í˜ì´ìŠ¤ ëˆŒëŸ¬ë„ íƒœê·¸ ì¶”ê°€ë˜ê²Œë”í•œê±°  (ìŠ¤í˜ì´ìŠ¤ 2ë²ˆ ëˆ„ë¥´ë©´ ì›ë˜ ëœë‹¤.)
      appendTag();
    }
    // else{ // ì…ë ¥ì¤‘ì¼ë•Œ
    //   // ì—¥ ê²€ìƒ‰ì œì™¸
    //   // ğŸ’ ì— ì´ (ê° ì§€ì ì—ì„œ í•œê¸€ì´ ì™„ì„±ë˜ëŠ” ì‹œì ì—ì„œ) ê²€ìƒ‰
    //   console.log("í•œê¸€ì™„ì„±",tagName);
    //   searchTags(tagName);
    // }
  });

  tagsInput.addEventListener("keydown",(e)=>{ // ğŸ’í‚¤ ì´ë²¤íŠ¸ í™•ì¸
    // console.log(e)
    if((e.code==="Enter" || e.code==="Space") && !composition){ // ì…ë ¥ì„ ë§‰ì•„ì„œ, ì œì¶œì„ ë§‰ëŠ”ë‹¤.
      e.preventDefault(); // ì´ë²¤íŠ¸ ë§‰ê¸°
      console.log("keydown");
      appendTag(); // enter, space ë¥¼ í–ˆì„ë•Œ, beforeend ì™€ ê°™ì€ ì´ë²¤íŠ¸ë¥¼ ë„£ê²Œí•˜ê¸°!
    }
  })

  tagsInput.addEventListener("change", async (e)=>{ //ğŸ’ // change ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì´ë²¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê² ë‹¤ // async ë¡œ ajax í†µì‹  ë¶ˆëŸ¬ì˜¤ê¸°
    console.log("change");
    appendTag();
  })

  tagsInput.addEventListener("input", async (e)=>{
    let tagName=tagsInput.value;
    if(tagName.length>0) {
    // if(tagName.length>0 && !composition) { // !composition í•œê¸€ì´ ì…ë ¥ì´ ëë‚¬ì„ë•Œ
      // í•´ì‹œíƒœê·¸ ì¡°íšŒ
      await searchTags(tagName);
    }
  });

  async function searchTags(tagName){
    let url=`/hashtag/${tagName}/search.do`;
    const resp=await fetch(url);
    const tags=await resp.json();
    tagsDataList.innerHTML="";
    // console.log(json);
    for(const tag of tags){
      // console.log(tag,tagOptComponent(tag))
      tagsDataList.insertAdjacentHTML("beforeend", tagOptComponent(tag));
    }
  }

  function tagOptComponent(tagObj){
    return `<option value="${tagObj.tag}">${tagObj.tag} ê²Œì‹œë¬¼${tagObj.bCnt}</option>>`;
  }

  function appendTag(){
    let tagName=tagsInput.value.trim(); // trim í•˜ëŠ” ì´ìœ ëŠ” ?
    tagsInput.value="";
    if(tagName.length===0){
      alert("í•œê¸€ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”");
      return; // ë©”ì„œë“œ(í•¨ìˆ˜) ì¢…ë£Œ
    }
    if(!tagsSet.has(tagName)) { // í•´ì‹œíƒœê·¸ë„¤ì„ì´ ì—†ì„ë•Œ,
      tagsSet.add(tagName); // í•´ì‹œíƒœê·¸ë¥¼ ë‹´ëŠ”ë‹¤.
      tagsCont.insertAdjacentHTML("beforeend",tagComponent(tagName)) // íƒœê·¸ ì»¨í¬ë„ŒíŠ¸
    } else{
      alert("ì´ë¯¸ ë“±ë¡ëœ íƒœê·¸ì…ë‹ˆë‹¤.");
    }
  }

  // íƒœê·¸ë…¸ë“œ
  // í•´ì‹œíƒœê·¸ ê°’ì„ ì„œë²„ì— ë„˜ê²¨ì•¼ í•´ì„œ, ìˆ¨ê²¨ì„œ ë„˜ê¸°ê¸° => a íƒœê·¸ ì•ˆì— input íƒœê·¸ //
  function tagComponent(tagName){ // íƒœê·¸ë…¸ë“œ // tagComponent ë¥¼ í˜¸ì¶œí•˜ë©´ íƒœê·¸ê°€ ë°˜í™˜(return)ëœë‹¤.
    return `
      <a href="javascript:void(0)" onclick="removeTag(this,'${tagName}')" class="btn btn-light btn-sm rounded-5 text-secondary" type=button>
      <div>
        <i class="bi bi-hash"></i>
        <span>${tagName}</span>
        <i class="bi bi-x ms-1"></i> <!-- ì‚­ì œë²„íŠ¼ìœ¼ë¡œ ì“¸ ì˜ˆì • -->
        <input type="hidden" name="tag" value="${tagName}">
      </div>
    </a>
    `;
  }


  function removeTag(tagNode, tagName){ // íƒœê·¸ ì‚­ì œë¥¼ í•˜ë ¤ë©´ íƒœê·¸ê°€ í•„ìš”í•˜ë‹¤.
    tagNode.remove(); // íƒœê·¸ì‚­ì œ // ë…¸ë“œê°ì²´ì— remove ê°€ ìˆë‹¤.
    tagsSet.delete(tagName); // í•´ì‹œíƒœê·¸ ë°°ì—´ì—ì„œë„ ì‚­ì œ
    alert(tagName+"ì‚­ì œ!");
  }
</script>