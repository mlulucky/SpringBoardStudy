<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.acorn.springboardstudy.mapper.BoardReplyMapper">
    <!-- BoardReplyMap : ë§ˆì´ë°”í‹°ìŠ¤ê°€ ìƒì„±í•˜ëŠ” í”„ë¡ì‹œ ê°ì²´ì´ë‹¤!
     collection ê°ì²´ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ì„œ(ì§€ì—°ë¡œë”©)ë•Œë¬¸ì— í•¸ë“¤ëŸ¬ í•„ë“œë“¤ì´ êµ¬í˜„ì´ ëœë‹¤.
     => dto ê°ì²´ê°€ ì•„ë‹ˆë¼ í”„ë¡ì‹œ ê°ì²´ê°€ ìƒì„±ëœë‹¤.
     -->
    <resultMap id="BoardReplyMap" type="BoardReplyDto">
        <id property="brId" column="br_id"/>
        <result property="bId" column="b_id"/>
        <result property="uId" column="u_id"/>
        <result property="parentBrId" column="parent_br_id"/>
        <result property="postTime" column="post_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="imgPath" column="img_path"/>
        <result property="status" column="status"/>
        <result property="content" column="content"/>
        <association property="likes">
            <result property="like" column="like"/>
            <result property="bad" column="bad"/>
            <result property="best" column="best"/>
            <result property="sad" column="sad"/>
        </association>
        <!-- ğŸì¢‹ì•„ìš” ìˆœìœ¼ë¡œ ì •ë ¬(ORDER BY) í•˜ë ¤ê³  ì¡°ì¸! -->

        <!-- collection ì¡°ì¸ - ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ -->
        <collection property="replies"
                    select="findByParentBrId"
                    column="br_id"
                    fetchType="lazy"/> <!-- select : ë‚´ë¶€ë§µí¼ì´ë¯€ë¡œ ë§µí¼ ê²½ë¡œë¥¼ ì•ˆì¨ë„ ëœë‹¤. -->
        <!-- ëŒ€ëŒ“ê¸€ -->
    </resultMap>
    <insert id="insertOne" useGeneratedKeys="true" keyProperty="brId" parameterType="BoardReplyDto">
        <!-- í‚¤ ìë™ìƒì„±. BoardReplyBto ì˜ brId ì— ìë™í‚¤ë¥¼ ë‹´ê² ë‹¤.
            useGeneratedKeys="true" : ìë™ìƒì„±. ì ˆëŒ€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ”ë‹¤.
        -->
        INSERT INTO board_replies (b_id, u_id, parent_br_id, img_path, content)
            VALUE (#{bId}, #{uId}, #{parentBrId}, #{imgPath}, #{content})
    </insert>
    <update id="updateOne" parameterType="BoardReplyDto">
        UPDATE board_replies
        SET img_path=#{imgPath}, content=#{content}
        WHERE br_id=#{brId}
    </update>
    <delete id="deleteOne">
        DELETE FROM board_replies
        WHERE br_id=#{brId}
    </delete>
    <select id="findByBIdAndParentBrIdIsNull" resultMap="BoardReplyMap"><!-- resultMap í˜¸ì¶œí•˜ë©´ ìë™ìœ¼ë¡œ ë§µí•‘ + ì¡°ì¸ -->
        SELECT r.*,
               COUNT(CASE WHEN l.status='LIKE' THEN 1 END) 'like',
               COUNT(CASE WHEN l.status='BAD' THEN 1 END) 'bad',
               COUNT(CASE WHEN l.status='BEST' THEN 1 END) 'best',
               COUNT(CASE WHEN l.status='SAD' THEN 1 END) 'sad'
            FROM board_replies r LEFT JOIN reply_likes l ON r.br_id=l.br_id
            WHERE parent_br_id IS NULL # ë¶€ëª¨ëŒ“ê¸€ì•„ì´ë””ê°€ null ì´ë¼ëŠ” ê±´ ëŒ“ê¸€!
              AND b_id=#{bId}
            GROUP BY r.br_id
            ORDER BY 'like'
# ì¡°íšŒí•œê²ƒ => ê·¸ë£¹í•‘ => ì •ë ¬ => í˜ì´ì§•
#     ?ì¡°ì¸ì´ ì—¬ëŸ¬ê°œì¸ ê²½ìš° USING ì„ ì•ˆì“°ê³  ì—¬ëŸ¬ê°œ ì“°ëŠ”ê²Œ ì¢‹ë‹¤.
    # ëŒ“ê¸€ ì°¾ê¸°
    </select>


    <select id="findByParentBrId" resultMap="BoardReplyMap">
        SELECT r.*,
               COUNT(CASE WHEN l.status='LIKE' THEN 1 END) 'like',
               COUNT(CASE WHEN l.status='BAD' THEN 1 END) 'bad',
               COUNT(CASE WHEN l.status='BEST' THEN 1 END) 'best',
               COUNT(CASE WHEN l.status='SAD' THEN 1 END) 'sad'
        FROM board_replies r LEFT JOIN reply_likes l ON r.br_id=l.br_id
        WHERE parent_br_id=#{brId} # ë¶€ëª¨ëŒ“ê¸€ì•„ì´ë””ê°€ ëŒ“ê¸€ì•„ì´ë””ë¼ëŠ”ê±´ ëŒ€ëŒ“ê¸€!
        GROUP BY r.br_id
        ORDER BY 'like'
    # í•´ë‹¹ parent_br_id ë¥¼ ì°¸ì¡°í•˜ëŠ” ëŒ€ëŒ“ê¸€
    </select>

<!--    ?ëŒ“ê¸€ ìˆ˜ì •ì‹œ ë¶ˆëŸ¬ì˜¬ ì˜ˆì •ì´ë¼ ì¢‹ì•„ìš”ë¥¼ ë°›ì€ ìˆ˜ëŠ” í•„ìš”ì—†ìŒ -->
<!--    ìƒì„¸í˜ì´ì§€ ì¡°íšŒì— ì‚¬ìš©í•  êµ¬ë¬¸-->
    <!-- Map ìœ¼ë¡œ í”„ë¡ì‹œ ê°ì²´ê°€ ëœë‹¤. ì™œ? ì»¬ë ‰ì…˜ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œ ì§€ì—°ë¡œë”©ì´ ë˜ì–´ìˆì–´ì„œ // handler ëŠ” ì§ë ¬í™”ê°€ ì•ˆë˜ì„œ ì‘ë‹µì„ ëª»í•œë‹¤. -->
    <select id="findByBrId" resultMap="BoardReplyMap">
        SELECT * FROM board_replies WHERE br_id=#{brId}
    # í•´ë‹¹ brId ì°¾ê¸°
    </select>
</mapper>
